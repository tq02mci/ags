name: æ»šåŠ¨éªŒè¯ä¸æ¨¡å‹æ ¡å‡†

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 1:00 è¿è¡Œï¼ˆæ•°æ®åŒæ­¥åï¼‰
    - cron: '0 17 * * *'  # UTC 17:00 = åŒ—äº¬æ—¶é—´ 01:00

  workflow_dispatch:
    inputs:
      ts_code:
        description: 'è‚¡ç¥¨ä»£ç  (ç•™ç©ºéªŒè¯æ‰€æœ‰)'
        required: false
        default: ''
      start_date:
        description: 'å¼€å§‹æ—¥æœŸ'
        required: true
        default: '2025-01-01'
      end_date:
        description: 'ç»“æŸæ—¥æœŸ'
        required: false
        default: ''
      model_type:
        description: 'æ¨¡å‹ç±»å‹'
        required: true
        default: 'xgboost'
        type: choice
        options:
          - xgboost
          - lightgbm
          - randomforest

jobs:
  rolling-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run rolling validation
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.ts_code }}" ]; then
            python scripts/rolling_validation.py \
              --ts-code ${{ github.event.inputs.ts_code }} \
              --start-date ${{ github.event.inputs.start_date }} \
              --end-date ${{ github.event.inputs.end_date }} \
              --model-type ${{ github.event.inputs.model_type }}
          else
            # é»˜è®¤éªŒè¯çƒ­é—¨è‚¡ç¥¨
            python scripts/rolling_validation.py \
              --ts-code 000001.SZ \
              --start-date ${{ github.event.inputs.start_date || '2025-01-01' }} \
              --end-date ${{ github.event.inputs.end_date || '' }} \
              --model-type ${{ github.event.inputs.model_type || 'xgboost' }}
          fi

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_id }}
          path: |
            models/validation/
            logs/
          retention-days: 30

      - name: Analyze validation results
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python scripts/rolling_validation.py --analyze --results-dir models/validation/

      - name: Update model performance to database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          import json
          import glob
          from src.database.connection import get_supabase_client

          supabase = get_supabase_client()

          # è¯»å–æœ€æ–°çš„æ ¡å‡†æŠ¥å‘Š
          report_files = glob.glob('models/validation/calibration_report_*.json')
          if report_files:
              latest_report = max(report_files, key=lambda x: x.split('_')[-1].split('.')[0])
              with open(latest_report) as f:
                  report = json.load(f)

              # ä¿å­˜åˆ°æ•°æ®åº“
              supabase.table('model_validation_results').insert({
                  'model_type': '${{ github.event.inputs.model_type || 'xgboost' }}',
                  'ts_code': '${{ github.event.inputs.ts_code || '000001.SZ' }}',
                  'validation_date': '${{ github.event.inputs.start_date || '2025-01-01' }}',
                  'optimal_threshold': report.get('optimal_threshold', 0.5),
                  'calibration_report': report.get('calibration_report', {}),
                  'run_id': '${{ github.run_id }}'
              }).execute()
              print('éªŒè¯ç»“æœå·²ä¿å­˜åˆ°æ•°æ®åº“')
          "

      - name: Create validation summary
        run: |
          echo "## ğŸ“Š æ»šåŠ¨éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è‚¡ç¥¨ä»£ç **: ${{ github.event.inputs.ts_code || '000001.SZ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éªŒè¯åŒºé—´**: ${{ github.event.inputs.start_date || '2025-01-01' }} ~ ${{ github.event.inputs.end_date || 'ä»Šå¤©' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å‹ç±»å‹**: ${{ github.event.inputs.model_type || 'xgboost' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "éªŒè¯ç»“æœå’Œå›¾è¡¨å·²ä¸Šä¼ åˆ° Artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ æ»šåŠ¨éªŒè¯å¤±è´¥',
              body: `éªŒè¯è¿è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚\n\nè¿è¡ŒID: ${{ github.run_id }}`
            })
